name: Release

on:
  push:
    branches: [ main ]
    # åªæœ‰å½“æäº¤ä¿¡æ¯åŒ…å« [build] æ—¶æ‰è§¦å‘
    paths-ignore:
      - '**.md'
      - 'docs/**'
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    if: "contains(github.event.head_commit.message, '[build]')"

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get latest tag
      id: get_latest_tag
      run: |
        # èŽ·å–æœ€æ–°æ ‡ç­¾ï¼Œå¦‚æžœæ²¡æœ‰åˆ™è®¾ç½®ä¸º v1.0.0
        git fetch --tags
        LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
        if [ -z "$LATEST_TAG" ]; then
          LATEST_TAG="v1.0.0"
        else
          # å°†ç‰ˆæœ¬å·åŠ 1
          MAJOR=$(echo $LATEST_TAG | cut -d. -f1)
          MINOR=$(echo $LATEST_TAG | cut -d. -f2)
          PATCH=$(echo $LATEST_TAG | cut -d. -f3)
          PATCH=$((PATCH + 1))
          LATEST_TAG="${MAJOR}.${MINOR}.${PATCH}"
        fi
        echo "NEW_VERSION=$LATEST_TAG" >> $GITHUB_ENV
        echo "RELEASE_NAME=MoBot-$LATEST_TAG" >> $GITHUB_ENV

    - name: Generate changelog
      id: changelog
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬åˆ°çŽ°åœ¨çš„æ‰€æœ‰æäº¤
        PREV_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
        if [ -z "$PREV_TAG" ]; then
          LOG=$(git log --pretty=format:"- %s" --reverse)
        else
          LOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --reverse)
        fi
        
        # è½¬æ¢æäº¤ä¿¡æ¯å‰ç¼€ä¸ºå›¾æ ‡
        LOG=$(echo "$LOG" | sed -e 's/^- feat:/- âœ¨ feat:/g' \
                               -e 's/^- fix:/- ðŸ› fix:/g' \
                               -e 's/^- docs:/- ðŸ“ docs:/g' \
                               -e 's/^- style:/- ðŸ’„ style:/g' \
                               -e 's/^- refactor:/- â™»ï¸ refactor:/g' \
                               -e 's/^- perf:/- âš¡ï¸ perf:/g' \
                               -e 's/^- test:/- âœ… test:/g' \
                               -e 's/^- build:/- ðŸ“¦ build:/g' \
                               -e 's/^- ci:/- ðŸ‘· ci:/g' \
                               -e 's/^- chore:/- ðŸ”§ chore:/g')
        
        # å°†æ›´æ–°æ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶
        echo "$LOG" > changelog.txt
        
        # å¯¹æ›´æ–°å†…å®¹è¿›è¡Œåˆ†ç±»
        echo "### âœ¨ æ–°åŠŸèƒ½" > release_notes.md
        echo "$LOG" | grep "âœ¨ feat:" >> release_notes.md || true
        echo -e "\n### ðŸ› ä¿®å¤" >> release_notes.md
        echo "$LOG" | grep "ðŸ› fix:" >> release_notes.md || true
        echo -e "\n### ðŸ“ æ–‡æ¡£" >> release_notes.md
        echo "$LOG" | grep "ðŸ“ docs:" >> release_notes.md || true
        echo -e "\n### â™»ï¸ é‡æž„" >> release_notes.md
        echo "$LOG" | grep "â™»ï¸ refactor:" >> release_notes.md || true
        echo -e "\n### âš¡ï¸ æ€§èƒ½ä¼˜åŒ–" >> release_notes.md
        echo "$LOG" | grep "âš¡ï¸ perf:" >> release_notes.md || true
        echo -e "\n### ðŸ”§ å…¶ä»–æ›´æ–°" >> release_notes.md
        echo "$LOG" | grep -v "âœ¨\|ðŸ›\|ðŸ“\|â™»ï¸\|âš¡ï¸" >> release_notes.md || true

    - name: Create Git tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a ${{ env.NEW_VERSION }} -m "Release ${{ env.NEW_VERSION }}"
        git push origin ${{ env.NEW_VERSION }}

    - name: Create Release ZIP
      run: |
        zip -r ${{ env.RELEASE_NAME }}.zip . -x "*.git*" "*.github*" "*.gitignore" "*.DS_Store"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.NEW_VERSION }}
        files: ${{ env.RELEASE_NAME }}.zip
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        name: Release ${{ env.NEW_VERSION }}
        body_path: release_notes.md 